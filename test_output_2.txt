Another command (pid=81452) is running. Waiting for it to complete on the server (server_pid=78647)...
Computing main repo mapping: 
Loading: 
Loading: 0 packages loaded
Analyzing: target //:test (0 packages loaded, 0 targets configured)
Analyzing: target //:test (0 packages loaded, 0 targets configured)

INFO: Analyzed target //:test (0 packages loaded, 2 targets configured).
[2,423 / 2,424] Testing //:test; 1s darwin-sandbox
[2,423 / 2,424] Testing //:test; 11s darwin-sandbox
[2,423 / 2,424] Testing //:test; 14s darwin-sandbox
FAIL: //:test (Exit 1) (see /private/var/tmp/_bazel_maus/00d397edd867a4184343b978ca9644d8/execroot/_main/bazel-out/darwin_arm64-fastbuild/testlogs/test/test.log)
INFO: From Testing //:test:
==================== Test output for //:test:

 RUN  v2.1.9 /private/var/tmp/_bazel_maus/00d397edd867a4184343b978ca9644d8/sandbox/darwin-sandbox/163/execroot/_main/bazel-out/darwin_arm64-fastbuild/bin/test_/test.runfiles/_main

 ✓ src/mechanics/abilities/modifier/Charm.test.ts (3 tests) 2ms
stdout | src/mechanics/abilities/passive/DarkClaw.test.ts > Dark Claw > should inflict 4 damage on speed roll doubles
0: Dark Claw dealt 4 damage to Test Enemy

stdout | src/mechanics/abilities/passive/DarkClaw.test.ts > Dark Claw > should inflict 4 damage on damage roll doubles
0: Dark Claw dealt 4 damage to Test Enemy

 ✓ src/mechanics/abilities/passive/DarkClaw.test.ts (4 tests) 3ms
stdout | src/mechanics/abilities/combat/Bolt.test.ts > Bolt > should release damage on subsequent onDamageRoll
Random dice roll result: 1
Random dice roll result: 2
Random dice roll result: 3
0: Bolt released! Rolled 6 (1+2+3). Ignored armour!
0: Bolt dealt 6 damage to Test Enemy
0: Bolt removed from Test Hero

 ❯ src/mechanics/abilities/combat/Bolt.test.ts (2 tests | 2 failed) 7ms
   × Bolt > should charge up when activated 4ms
     → expected false to be true // Object.is equality
   × Bolt > should release damage on subsequent onDamageRoll 2ms
     → skipDamagePhase is not defined
 ❯ src/mechanics/abilities/passive/Venom.test.ts (4 tests | 4 failed) 7ms
   × Venom > should deal 2 damage by default 5ms
     → expected 20 to be 18 // Object.is equality
   × Venom > should deal 3 damage with Deadly Poisons 1ms
     → expected 20 to be 17 // Object.is equality
   × Venom > should deal 4 damage with Poison Mastery 0ms
     → expected 20 to be 16 // Object.is equality
   × Venom > should not deal damage if damage was only dealt to hero 1ms
     → expected [] to be undefined
 ✓ src/components/Combat/CombatDice.test.tsx (4 tests) 36ms
 ❯ src/hooks/useCombatBackpack.test.ts (0 test)
 ❯ src/mechanics/CombatEngine.test.ts (0 test)
stdout | src/mechanics/abilities/combat/Haunt.test.ts > Haunt > should summon spirit
0: Haunt Spirit applied effect  to Test Enemy
0: Used ability: Haunt. Spirit summoned!

stdout | src/mechanics/abilities/combat/Haunt.test.ts > Haunt > should inflict damage at round end if spirit active
0: Haunt dealt 2 damage to Test Enemy

stdout | src/mechanics/abilities/combat/Haunt.test.ts > Haunt > should dispel on double roll
0: Haunt Spirit removed from Test Enemy
0: Rolled a double! Haunt spirit dispelled.

 ✓ src/mechanics/abilities/combat/Haunt.test.ts (3 tests) 5ms
stdout | src/mechanics/abilities/passive/CleansingLight.test.ts > Cleansing Light > should heal the hero at the end of the round
0: Cleansing Light healed 2 health to Test Hero

stdout | src/mechanics/abilities/passive/CleansingLight.test.ts > Cleansing Light > should not heal beyond max health
0: Cleansing Light healed 1 health to Test Hero

 ✓ src/mechanics/abilities/passive/CleansingLight.test.ts (3 tests) 2ms
stdout | src/mechanics/abilities/passive/LifeSpark.test.ts > Life Spark > should heal on doubles in speed roll
0: Life Spark healed 4 health to Test Hero

stdout | src/mechanics/abilities/passive/LifeSpark.test.ts > Life Spark > should heal on doubles in damage roll
0: Life Spark healed 4 health to Test Hero

 ✓ src/mechanics/abilities/passive/LifeSpark.test.ts (3 tests) 5ms
 ❯ src/components/Hero/EquipmentSlots.test.tsx (0 test)
stdout | src/mechanics/abilities/speed/Execution.test.ts > Execution > should reduce enemy health to zero if conditions are met
0: Execution dealt 5 damage to Test Enemy

 ✓ src/mechanics/abilities/speed/Execution.test.ts (3 tests) 3ms
stdout | src/mechanics/abilities/speed/TimeShift.test.ts > Time Shift > should add modifier to match enemy speed
0: Time Shift applied effect [+4 speed/3rd] to Test Hero

 ✓ src/mechanics/abilities/speed/TimeShift.test.ts (2 tests) 3ms
stdout | src/mechanics/abilities/speed/TimeShift.test.ts > Time Shift > should reduce speed if enemy is slower
0: Time Shift applied effect [-3 speed/3rd] to Test Hero

stdout | src/mechanics/abilities/combat/Shock.test.ts > Shock! > should inflict extra damage for high armour enemy
0: Shock! dealt 2 damage to Test Enemy

 ✓ src/mechanics/abilities/combat/Shock.test.ts (1 test) 2ms
 ❯ src/mechanics/abilities/combat/Corruption.test.ts (2 tests | 2 failed) 5ms
   × Corruption > should apply corruption buff on activate if damage dealt 4ms
     → expected undefined to be true // Object.is equality
   × Corruption > should not activate if no damage dealt 1ms
     → expected undefined to be false // Object.is equality
stdout | src/mechanics/abilities/combat/Overpower.test.ts > Overpower > should block attack and deal counter damage
Random dice roll result: 4
Random dice roll result: 5
1: Overpower dealt 9 damage to Test Enemy
undefined: Overpower blocked attack

 ❯ src/mechanics/abilities/combat/Overpower.test.ts (2 tests | 1 failed) 12ms
   × Overpower > should block attack and deal counter damage 11ms
     → expected { …(12) } to deeply equal ObjectContaining{…}
stdout | src/mechanics/abilities/combat/Riposte.test.ts > Riposte > should inflict damage back
0: Riposte dealt 2 damage to Test Enemy

 ✓ src/mechanics/abilities/combat/Riposte.test.ts (2 tests) 2ms
stdout | src/mechanics/abilities/combat/Overload.test.ts > Overload > should add extra damage die if winner is hero and phase is damage-roll
0: Overload applied effect [+1 damageDice/1rd] to Test Hero

 ❯ src/mechanics/abilities/combat/Overload.test.ts (3 tests | 3 failed) 18ms
   × Overload > should add extra damage die if winner is hero and phase is damage-roll 8ms
     → Target cannot be null or undefined.
   × Overload > should not activate if not damage-roll phase 7ms
     → expected { …(11) } to deeply equal {}
   × Overload > should not activate if winner is not hero 2ms
     → expected { …(11) } to deeply equal {}
 ✓ src/hooks/useHero.test.ts (3 tests) 17ms
stdout | src/mechanics/abilities/combat/Puncture.test.ts > Puncture > should inflict 2 dice damage and reduce armour
0: Puncture dealt 9 damage to Test Enemy
0: Puncture applied effect [-1 armour/∞] to Test Enemy
undefined: Puncture dealt damage and reduced armour

 ✓ src/mechanics/abilities/combat/Puncture.test.ts (1 test) 3ms
 ❯ src/mechanics/abilities/modifier/Heal.test.ts (0 test)
stdout | src/mechanics/abilities/passive/Bleed.test.ts > Bleed > should deal 1 damage at round end
0: Bleed applied effect  to Test Enemy

 ❯ src/mechanics/abilities/passive/Bleed.test.ts (1 test | 1 failed) 7ms
   × Bleed > should deal 1 damage at round end 6ms
     → expected [ Array(1) ] to deeply equal ArrayContaining{…}
stdout | src/mechanics/abilities/combat/Evade.test.ts > Evade > should avoid damage
undefined: Used ability: Evade. Avoided attack!

 ✓ src/mechanics/abilities/combat/Evade.test.ts (2 tests) 3ms
stdout | src/mechanics/abilities/passive/ShieldSpin.test.ts > Shield Spin > should inflict damage equal to 1 die per opponent [1] rolled
0: Shield Spin dealt 2 damage to Test Enemy

 ✓ src/mechanics/abilities/passive/ShieldSpin.test.ts (2 tests) 2ms
stdout | src/mechanics/abilities/passive/Leech.test.ts > Leech > should heal hero when damage is dealt to enemy
0: Leech healed 2 health to Test Hero

stdout | src/mechanics/abilities/passive/Leech.test.ts > Leech > should not heal beyond max health
0: Leech healed 1 health to Test Hero

 ✓ src/mechanics/abilities/passive/Leech.test.ts (3 tests) 3ms
stdout | src/mechanics/abilities/combat/Reflect.test.ts > Reflect > should reflect damage to vampire
0: Reflect dealt 5 damage to Vampire Lord

 ✓ src/mechanics/abilities/combat/Reflect.test.ts (2 tests) 3ms
stdout | src/mechanics/abilities/combat/ShadowFury.test.ts > Shadow Fury > should add weapon speed to damage score
0: Shadow Fury applied effect [+3 damageModifier/1rd] to Test Hero
0: Used ability: Shadow Fury (+3 Damage).

 ✓ src/mechanics/abilities/combat/ShadowFury.test.ts (1 test) 2ms
 ❯ src/mechanics/abilities/combat/Disrupt.test.ts (2 tests | 2 failed) 4ms
   × Disrupt > should apply magic reduction on activate if damage dealt 3ms
     → Cannot read properties of undefined (reading 'some')
   × Disrupt > should not activate if no damage dealt 0ms
     → Cannot read properties of undefined (reading 'some')
stdout | src/mechanics/abilities/combat/Parry.test.ts > Parry > should be activatable only in damage-roll phase when enemy won
0: Used ability: Parry. Opponent's attack blocked!

 ❯ src/mechanics/abilities/combat/Parry.test.ts (1 test | 1 failed) 6ms
   × Parry > should be activatable only in damage-roll phase when enemy won 6ms
     → expected undefined to deeply equal [ { value: +0, isRerolled: false } ]
stdout | src/mechanics/abilities/passive/Lightning.test.ts > Lightning > should inflict 2 damage back when hero takes damage
0: Lightning dealt 2 damage to Test Enemy

 ✓ src/mechanics/abilities/passive/Lightning.test.ts (2 tests) 4ms
stdout | src/mechanics/abilities/combat/Sacrifice.test.ts > Sacrifice > should absorb damage and remove shades
0: Shades removed from Test Hero
undefined: Used ability: Sacrifice. Shades absorbed the damage!

 ✓ src/mechanics/abilities/combat/Sacrifice.test.ts (1 test) 3ms
 ❯ src/mechanics/abilities/combat/Dodge.test.ts (2 tests | 1 failed) 5ms
   × Dodge > should avoid damage 4ms
     → Cannot read properties of undefined (reading 'some')
stdout | src/mechanics/abilities/combat/Cripple.test.ts > Cripple > should apply speed reduction on activate when damage is dealt
0: Cripple applied effect [-1 speed/3rd] to Test Enemy

 ❯ src/mechanics/abilities/combat/Cripple.test.ts (2 tests | 2 failed) 12ms
   × Cripple > should apply speed reduction on activate when damage is dealt 7ms
     → Target cannot be null or undefined.
   × Cripple > should not activate if no damage dealt to enemy 4ms
     → expected { …(12) } to deeply equal {}
 ❯ src/mechanics/abilities/speed/Shackle.test.ts (0 test)
 ❯ src/mechanics/abilities/combat/Backfire.test.ts (1 test | 1 failed) 6ms
   × Backfire > should replace damage roll with specific damage 5ms
     → expected false to be true // Object.is equality
stdout | src/mechanics/abilities/combat/Rust.test.ts > Rust > should reduce opponent armour if damage dealt
0: Rust applied effect [-2 armour/∞] to Test Enemy

 ❯ src/mechanics/abilities/combat/Rust.test.ts (2 tests | 2 failed) 15ms
   × Rust > should reduce opponent armour if damage dealt 5ms
     → Target cannot be null or undefined.
   × Rust > should not activate if no damage dealt 9ms
     → expected { …(12) } to deeply equal {}
stdout | src/mechanics/abilities/combat/Slam.test.ts > Slam > should stop opponent damage and slow them
0: Slam applied effect [-1 speed/2rd] to Test Enemy
0: Used ability: Slam. Blocked attack and slowed opponent.

 ✓ src/mechanics/abilities/combat/Slam.test.ts (1 test) 3ms
stdout | src/mechanics/abilities/speed/Demolish.test.ts > Demolish > should add speed reduction and armour reduction to enemy on activation
0: Demolish (Speed) applied effect [-1 speedDice/1rd] to Test Enemy
0: Demolish (Armour) applied effect [-1 armour/∞] to Test Enemy

 ✓ src/mechanics/abilities/speed/Demolish.test.ts (1 test) 3ms
stdout | src/mechanics/abilities/combat/IceShards.test.ts > Ice Shards > should inflict magic score damage
0: Ice Shards dealt 5 damage to Test Enemy

 ✓ src/mechanics/abilities/combat/IceShards.test.ts (1 test) 2ms
stdout | src/mechanics/abilities/combat/Brutality.test.ts > Brutality > should stop opponent damage and inflict damage back
0: Brutality! Blocked attack and inflicted 10 damage (6+4).

 ❯ src/mechanics/abilities/combat/Brutality.test.ts (1 test | 1 failed) 12ms
   × Brutality > should stop opponent damage and inflict damage back 12ms
     → expected undefined to deeply equal [ { value: +0, isRerolled: false } ]
 ❯ src/mechanics/abilities/combat/NaturesRevenge.test.ts (1 test | 1 failed) 7ms
   × Nature's Revenge > should inflict damage and slow opponent 4ms
     → expected false to be true // Object.is equality
stdout | src/mechanics/abilities/combat/Deflect.test.ts > Deflect > should stop opponent damage and inflict damage back
0: Deflect! Blocked attack and inflicted 2 damage (1+1).

 ❯ src/mechanics/abilities/combat/Deflect.test.ts (1 test | 1 failed) 10ms
   × Deflect > should stop opponent damage and inflict damage back 9ms
     → expected undefined to deeply equal [ { value: +0, isRerolled: false } ]
stdout | src/mechanics/abilities/combat/DarkPact.test.ts > Dark Pact > should sacrifice health for damage
0: Dark Pact Cost dealt 4 damage to Test Hero
0: Dark Pact applied effect [+4 damageModifier/1rd] to Test Hero
0: Used ability: Dark Pact. Sacrificed health for power!

 ❯ src/mechanics/abilities/combat/DarkPact.test.ts (1 test | 1 failed) 7ms
   × Dark Pact > should sacrifice health for damage 6ms
     → expected [ { …(4) } ] to have a length of 2 but got 1
stdout | src/mechanics/abilities/passive/Vitriol.test.ts > Vitriol > should inflict 1 damage to both enemy and hero on round end
0: Vitriol dealt 1 damage to Test Enemy
0: Vitriol dealt 1 damage to Test Hero

 ✓ src/mechanics/abilities/passive/Vitriol.test.ts (1 test) 2ms
stdout | src/mechanics/abilities/combat/BlackRain.test.ts > Black Rain > should inflict random damage to enemy
0: Black Rain dealt 5 damage to Test Enemy
undefined: Black Rain dealing 1d6 to all enemies

 ❯ src/mechanics/abilities/combat/BlackRain.test.ts (1 test | 1 failed) 12ms
   × Black Rain > should inflict random damage to enemy 11ms
     → expected { …(11) } to deeply equal ObjectContaining{…}
stdout | src/mechanics/abilities/combat/Retaliation.test.ts > Retaliation > should inflict damage back
Random dice roll result: 3
0: Retaliation dealt 3 damage to Test Enemy

 ✓ src/mechanics/abilities/combat/Retaliation.test.ts (1 test) 3ms
stdout | src/mechanics/abilities/combat/Windwalker.test.ts > Windwalker > should use speed dice for damage
0: Windwalker! Rolled 5 dice for 13 damage (5+2+2+2+2).

 ❯ src/mechanics/abilities/combat/Windwalker.test.ts (1 test | 1 failed) 8ms
   × Windwalker > should use speed dice for damage 7ms
     → Target cannot be null or undefined.
stdout | src/mechanics/abilities/combat/Judgement.test.ts > Judgement > should inflict half speed as damage back
0: Judgement dealt 4 damage to Test Enemy

 ✓ src/mechanics/abilities/combat/Judgement.test.ts (1 test) 2ms
 ❯ src/mechanics/abilities/passive/Barbs.test.ts (2 tests | 2 failed) 8ms
   × Barbs > should inflict 1 damage to enemy on round end 4ms
     → expected 10 to be 9 // Object.is equality
   × Barbs > should not reduce enemy health below 0 3ms
     → expected { …(11) } to deeply equal {}
stdout | src/mechanics/abilities/combat/Ignite.test.ts > Ignite > should inflict damage and apply burn
0: Ignite applied effect  to Test Enemy
0: Ignite dealt 8 damage to Test Enemy

 ✓ src/mechanics/abilities/combat/Ignite.test.ts (1 test) 3ms
 ❯ src/mechanics/abilities/combat/Impale.test.ts (1 test | 1 failed) 6ms
   × Impale > should apply damage buff and speed debuff 4ms
     → Cannot read properties of undefined (reading 'activeEffects')
stdout | src/mechanics/abilities/passive/FirstStrike.test.ts > First Strike > should deal 1d6 damage before combat
0: First Strike dealt 4 damage to Test Hero

 ❯ src/mechanics/abilities/passive/FirstStrike.test.ts (1 test | 1 failed) 7ms
   × First Strike > should deal 1d6 damage before combat 6ms
     → expected 20 to be 16 // Object.is equality
 ❯ src/mechanics/abilities/combat/Ensnare.test.ts (1 test | 1 failed) 6ms
   × Ensnare > should apply Ensnare effect 5ms
     → Target cannot be null or undefined.
stdout | src/mechanics/abilities/combat/Pound.test.ts > Pound > should apply damage buff and self speed debuff
0: Pound (Damage) applied effect [+3 damageModifier/1rd] to Test Hero
0: Pound (Speed) applied effect [-1 speed/2rd] to Test Hero

stdout | src/mechanics/abilities/combat/BansheeWail.test.ts > Banshee Wail > should stop opponent damage roll
undefined: Used ability: Banshee Wail. Opponent's attack silenced!

 ✓ src/mechanics/abilities/combat/BansheeWail.test.ts (1 test) 2ms
 ✓ src/mechanics/abilities/combat/Pound.test.ts (1 test) 3ms
stdout | src/mechanics/abilities/passive/Thorns.test.ts > Thorns > should inflict 1 damage to enemy on round end
0: Thorns dealt 1 damage to Test Hero

 ❯ src/mechanics/abilities/passive/Thorns.test.ts (1 test | 1 failed) 7ms
   × Thorns > should inflict 1 damage to enemy on round end 7ms
     → expected { …(11) } to deeply equal ObjectContaining{…}
 ✓ src/mechanics/abilities/modifier/CriticalStrike.test.ts (1 test) 2ms
stdout | src/mechanics/abilities/modifier/CriticalStrike.test.ts > Critical Strike > should change all damage rolls to 6
0: Damage rolled 6, 6 = (12 )
0: Used ability: Critical strike. New damage roll: 6, 6

 ❯ src/mechanics/abilities/combat/ShieldWall.test.ts (1 test | 1 failed) 4ms
   × Shield Wall > should double armour and inflict damage 4ms
     → Cannot read properties of undefined (reading 'stats')
 ❯ src/mechanics/abilityRegistry.test.ts (0 test)
stdout | src/mechanics/abilities/combat/Vanish.test.ts > Vanish > should avoid damage
0: Used ability: Vanish. Disappeared from sight!

 ✓ src/mechanics/abilities/combat/Vanish.test.ts (1 test) 2ms
stdout | src/mechanics/abilities/combat/ThornArmour.test.ts > Thorn Armour > should buff armour and inflict damage
0: Thorn Armour applied effect [+3 armour/1rd] to Test Hero
0: Thorn Armour dealt 2 damage to Test Enemy
0: Thorn Armour active! Armour +3, inflicted 2 damage.

 ✓ src/mechanics/abilities/combat/ThornArmour.test.ts (1 test) 3ms
stdout | src/mechanics/abilities/passive/FireAura.test.ts > Fire Aura > should inflict 1 damage to enemy on round end
0: Fire Aura dealt 1 damage to Test Hero

 ❯ src/mechanics/abilities/passive/FireAura.test.ts (1 test | 1 failed) 6ms
   × Fire Aura > should inflict 1 damage to enemy on round end 5ms
     → expected 10 to be 9 // Object.is equality
stdout | src/mechanics/abilities/combat/Cleave.test.ts > Cleave > should inflict damage to enemy
0: Cleave dealt 3 damage to Test Enemy
undefined: Cleave struck all enemies

 ✓ src/mechanics/abilities/combat/Cleave.test.ts (1 test) 3ms
stdout | src/mechanics/abilities/combat/Command.test.ts > Command > should set winner to hero
0: Used ability: Command. Seized the initiative!

 ✓ src/mechanics/abilities/combat/Command.test.ts (1 test) 2ms
stdout | src/mechanics/abilities/combat/Rake.test.ts > Rake > should inflict 3 dice damage
0: Rake dealt 13 damage to Test Enemy
0: Rake! Inflicted 13 damage (2+5+6).
undefined: Rake skipped normal damage roll

 ✓ src/mechanics/abilities/combat/Rake.test.ts (1 test) 2ms
stdout | src/mechanics/abilities/combat/Surge.test.ts > Surge > should buff magic and debuff speed
0: Surge (Magic) applied effect [+3 magic/1rd] to Test Hero
0: Surge (Speed) applied effect [-1 speed/2rd] to Test Hero
0: Used ability: Surge.

 ✓ src/mechanics/abilities/combat/Surge.test.ts (1 test) 3ms
 ✓ src/mechanics/abilities/passive/Sear.test.ts (2 tests) 2ms
stdout | src/mechanics/abilities/combat/HeadButt.test.ts > Head Butt > should stop opponent damage
undefined: Used ability: Head Butt. Stopped attack!

 ❯ src/mechanics/abilities/combat/HeadButt.test.ts (1 test | 1 failed) 6ms
   × Head Butt > should stop opponent damage 5ms
     → expected 'passive-damage' to be 'round-end' // Object.is equality
stdout | src/mechanics/abilities/passive/FirstCut.test.ts > First Cut > should inflict 1 damage to enemy on combat start
0: First Cut dealt 1 damage to Test Enemy

 ✓ src/mechanics/abilities/passive/FirstCut.test.ts (1 test) 4ms
stdout | src/mechanics/abilities/combat/Piercing.test.ts > Piercing > should reduce enemy armour to 0
0: Piercing applied effect [-5 armour/1rd] to Test Enemy

 ✓ src/mechanics/abilities/combat/Piercing.test.ts (1 test) 2ms
stdout | src/mechanics/abilities/speed/SwampLegs.test.ts > Swamp Legs > should add speed reduction to enemy on activation
0: Swamp Legs applied effect [-1 speed/1rd] to Test Enemy

 ✓ src/mechanics/abilities/speed/SwampLegs.test.ts (1 test) 4ms
 ❯ src/mechanics/abilities/combat/Hamstring.test.ts (1 test | 1 failed) 5ms
   × Hamstring > should apply Hamstring effect 4ms
     → Cannot read properties of undefined (reading 'activeEffects')
stdout | src/mechanics/abilities/combat/SporeCloud.test.ts > Spore Cloud > should inflict 2 dice damage back
Random dice roll result: 2
Random dice roll result: 3
0: Spore Cloud dealt 5 damage to Test Enemy
0: Spore Cloud! Inflicted 5 damage back (2+3).

 ❯ src/mechanics/abilities/combat/SporeCloud.test.ts (1 test | 1 failed) 20ms
   × Spore Cloud > should inflict 2 dice damage back 20ms
     → expected [] to have a length of 1 but got +0
stdout | src/mechanics/abilities/combat/ThornFist.test.ts > Thorn Fist > should inflict 2 dice damage back
Random dice roll result: 2
Random dice roll result: 3
0: Thorn Fist dealt 5 damage to Test Enemy
0: Thorn Fist! Inflicted 5 damage back (2+3).

 ❯ src/mechanics/abilities/combat/ThornFist.test.ts (1 test | 1 failed) 8ms
   × Thorn Fist > should inflict 2 dice damage back 8ms
     → expected [] to have a length of 1 but got +0
 ✓ src/mechanics/abilities/passive/Acid.test.ts (1 test) 2ms
stdout | src/mechanics/abilities/combat/Sideswipe.test.ts > Sideswipe > should inflict damage back
Random dice roll result: 3
0: Sideswipe dealt 3 damage to Test Enemy

 ❯ src/mechanics/abilities/combat/Sideswipe.test.ts (1 test | 1 failed) 7ms
   × Sideswipe > should inflict damage back 6ms
     → expected [] to have a length of 1 but got +0
stdout | src/mechanics/abilities/combat/Rebound.test.ts > Rebound > should increase speed after taking damage
0: Rebound applied effect [+2 speed/2rd] to Test Hero

 ✓ src/mechanics/abilities/combat/Rebound.test.ts (1 test) 2ms
 ✓ src/mechanics/abilities/modifier/LastLaugh.test.ts (1 test) 2ms
stdout | src/mechanics/abilities/combat/AvengingSpirit.test.ts > Avenging Spirit > should inflict damage back on taking partial damage
0: Avenging Spirit dealt 2 damage to Test Enemy

 ✓ src/mechanics/abilities/combat/AvengingSpirit.test.ts (1 test) 2ms
stdout | src/mechanics/abilities/combat/Sidestep.test.ts > Sidestep > should boost armour by 200 on activation
0: Sidestep applied effect [+200 armour/1rd] to Test Hero

 ❯ src/mechanics/abilities/combat/Sidestep.test.ts (1 test | 1 failed) 4ms
   × Sidestep > should boost armour by 200 on activation 3ms
     → Cannot read properties of undefined (reading '0')
 ❯ src/mechanics/abilities/combat/FeralFury.test.ts (1 test | 1 failed) 5ms
   × Feral Fury > should add extra damage die 5ms
     → Cannot read properties of undefined (reading 'activeEffects')
stdout | src/mechanics/abilities/combat/FatalBlow.test.ts > Fatal Blow > should apply modifier on activate
0: Fatal Blow applied effect  to Test Hero
0: Used ability: Fatal Blow.

 ❯ src/mechanics/abilities/combat/FatalBlow.test.ts (1 test | 1 failed) 8ms
   × Fatal Blow > should apply modifier on activate 4ms
     → Target cannot be null or undefined.
stdout | src/mechanics/abilities/speed/Webbed.test.ts > Webbed > should reduce enemy speed dice by 1
0: Webbed applied effect [-1 speedDice/1rd] to Test Enemy

 ✓ src/mechanics/abilities/speed/Webbed.test.ts (1 test) 3ms
 ❯ src/mechanics/abilities/combat/DeepWound.test.ts (1 test | 1 failed) 3ms
   × Deep Wound > should add 1 damage die 3ms
     → Cannot read properties of undefined (reading 'stats')
 ❯ src/hooks/useCombat.test.ts (0 test)

⎯⎯⎯⎯⎯⎯ Failed Suites 7 ⎯⎯⎯⎯⎯⎯⎯

 FAIL  src/hooks/useCombat.test.ts [ src/hooks/useCombat.test.ts ]
 FAIL  src/mechanics/abilityRegistry.test.ts [ src/mechanics/abilityRegistry.test.ts ]
 FAIL  src/mechanics/abilities/modifier/Heal.test.ts [ src/mechanics/abilities/modifier/Heal.test.ts ]
 FAIL  src/mechanics/abilities/speed/Shackle.test.ts [ src/mechanics/abilities/speed/Shackle.test.ts ]
Error: Failed to resolve import "../../../utils/statUtils" from "src/mechanics/abilities/modifier/Heal.ts". Does the file exist?
  Plugin: vite:import-analysis
  File: /private/var/tmp/_bazel_maus/00d397edd867a4184343b978ca9644d8/sandbox/darwin-sandbox/163/execroot/_main/bazel-out/darwin_arm64-fastbuild/bin/test_/test.runfiles/_main/src/mechanics/abilities/modifier/Heal.ts:2:24
  1  |  import { registerAbility } from "../../abilityRegistry";
  2  |  import { addLogs } from "../../../utils/statUtils";
     |                           ^
  3  |  function canActivate(state, _owner) {
  4  |    if (!state.hero) return false;
 ❯ TransformPluginContext._formatError node_modules/.aspect_rules_js/vite@5.4.21_34323803/node_modules/vite/dist/node/chunks/dep-BK3b2jBa.js:49258:41
 ❯ TransformPluginContext.error node_modules/.aspect_rules_js/vite@5.4.21_34323803/node_modules/vite/dist/node/chunks/dep-BK3b2jBa.js:49253:16
 ❯ normalizeUrl node_modules/.aspect_rules_js/vite@5.4.21_34323803/node_modules/vite/dist/node/chunks/dep-BK3b2jBa.js:64307:23
 ❯ node_modules/.aspect_rules_js/vite@5.4.21_34323803/node_modules/vite/dist/node/chunks/dep-BK3b2jBa.js:64439:39
 ❯ TransformPluginContext.transform node_modules/.aspect_rules_js/vite@5.4.21_34323803/node_modules/vite/dist/node/chunks/dep-BK3b2jBa.js:64366:7
 ❯ PluginContainer.transform node_modules/.aspect_rules_js/vite@5.4.21_34323803/node_modules/vite/dist/node/chunks/dep-BK3b2jBa.js:49099:18
 ❯ loadAndTransform node_modules/.aspect_rules_js/vite@5.4.21_34323803/node_modules/vite/dist/node/chunks/dep-BK3b2jBa.js:51978:27

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[1/52]⎯

 FAIL  src/hooks/useCombatBackpack.test.ts [ src/hooks/useCombatBackpack.test.ts ]
 FAIL  src/mechanics/CombatEngine.test.ts [ src/mechanics/CombatEngine.test.ts ]
Error: Failed to resolve import "../../../utils/statUtils" from "src/mechanics/abilities/modifier/Heal.ts". Does the file exist?
  Plugin: vite:import-analysis
  File: /private/var/tmp/_bazel_maus/00d397edd867a4184343b978ca9644d8/sandbox/darwin-sandbox/163/execroot/_main/bazel-out/darwin_arm64-fastbuild/bin/test_/test.runfiles/_main/src/mechanics/abilities/modifier/Heal.ts:2:24
  1  |  import { registerAbility } from "../../abilityRegistry";
  2  |  import { addLogs } from "../../../utils/statUtils";
     |                           ^
  3  |  function canActivate(state, _owner) {
  4  |    if (!state.hero) return false;
 ❯ TransformPluginContext._formatError node_modules/.aspect_rules_js/vite@5.4.21_34323803/node_modules/vite/dist/node/chunks/dep-BK3b2jBa.js:49258:41
 ❯ TransformPluginContext.error node_modules/.aspect_rules_js/vite@5.4.21_34323803/node_modules/vite/dist/node/chunks/dep-BK3b2jBa.js:49253:16
 ❯ normalizeUrl node_modules/.aspect_rules_js/vite@5.4.21_34323803/node_modules/vite/dist/node/chunks/dep-BK3b2jBa.js:64307:23
 ❯ node_modules/.aspect_rules_js/vite@5.4.21_34323803/node_modules/vite/dist/node/chunks/dep-BK3b2jBa.js:64439:39
 ❯ TransformPluginContext.transform node_modules/.aspect_rules_js/vite@5.4.21_34323803/node_modules/vite/dist/node/chunks/dep-BK3b2jBa.js:64366:7
 ❯ PluginContainer.transform node_modules/.aspect_rules_js/vite@5.4.21_34323803/node_modules/vite/dist/node/chunks/dep-BK3b2jBa.js:49099:18
 ❯ loadAndTransform node_modules/.aspect_rules_js/vite@5.4.21_34323803/node_modules/vite/dist/node/chunks/dep-BK3b2jBa.js:51978:27

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[2/52]⎯

 FAIL  src/components/Hero/EquipmentSlots.test.tsx [ src/components/Hero/EquipmentSlots.test.tsx ]
Error: Failed to resolve import "../../utils/statUtils" from "src/components/Hero/EquipmentSlot.tsx". Does the file exist?
  Plugin: vite:import-analysis
  File: /private/var/tmp/_bazel_maus/00d397edd867a4184343b978ca9644d8/sandbox/darwin-sandbox/163/execroot/_main/bazel-out/darwin_arm64-fastbuild/bin/test_/test.runfiles/_main/src/components/Hero/EquipmentSlot.tsx:4:28
  1  |  import { jsxDEV } from "react/jsx-dev-runtime";
  2  |  import "./EquipmentSlot.css";
  3  |  import { getStatIcon } from "../../utils/statUtils";
     |                               ^
  4  |  const EquipmentSlot = ({ label, icon, item, onClick, className = "" }) => {
  5  |    return /* @__PURE__ */ jsxDEV(
 ❯ TransformPluginContext._formatError node_modules/.aspect_rules_js/vite@5.4.21_34323803/node_modules/vite/dist/node/chunks/dep-BK3b2jBa.js:49258:41
 ❯ TransformPluginContext.error node_modules/.aspect_rules_js/vite@5.4.21_34323803/node_modules/vite/dist/node/chunks/dep-BK3b2jBa.js:49253:16
 ❯ normalizeUrl node_modules/.aspect_rules_js/vite@5.4.21_34323803/node_modules/vite/dist/node/chunks/dep-BK3b2jBa.js:64307:23
 ❯ node_modules/.aspect_rules_js/vite@5.4.21_34323803/node_modules/vite/dist/node/chunks/dep-BK3b2jBa.js:64439:39
 ❯ TransformPluginContext.transform node_modules/.aspect_rules_js/vite@5.4.21_34323803/node_modules/vite/dist/node/chunks/dep-BK3b2jBa.js:64366:7
 ❯ PluginContainer.transform node_modules/.aspect_rules_js/vite@5.4.21_34323803/node_modules/vite/dist/node/chunks/dep-BK3b2jBa.js:49099:18
 ❯ loadAndTransform node_modules/.aspect_rules_js/vite@5.4.21_34323803/node_modules/vite/dist/node/chunks/dep-BK3b2jBa.js:51978:27

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[3/52]⎯

⎯⎯⎯⎯⎯⎯ Failed Tests 45 ⎯⎯⎯⎯⎯⎯⎯

 FAIL  src/mechanics/abilities/passive/Barbs.test.ts > Barbs > should inflict 1 damage to enemy on round end
AssertionError: expected 10 to be 9 // Object.is equality

- Expected
+ Received

- 9
+ 10

 ❯ src/mechanics/abilities/passive/Barbs.test.ts:16:46
     14|         const updates = barbs?.onPassiveAbility?.(state, 'hero');
     15| 
     16|         expect(updates?.enemy?.stats.health).toBe(9);
       |                                              ^
     17|         expect(updates?.logs?.[0].message).toContain('Barbs dealt 1 da…
     18|     });

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[4/52]⎯

 FAIL  src/mechanics/abilities/passive/Barbs.test.ts > Barbs > should not reduce enemy health below 0
AssertionError: expected { …(11) } to deeply equal {}

- Expected
+ Received

- Object {}
+ Object {
+   "backpack": Array [],
+   "bonusDamage": Array [
+     Object {
+       "amount": 1,
+       "source": "Barbs",
+       "target": "hero",
+     },
+   ],
+   "damage": undefined,
+   "enemy": Object {
+     "activeAbilities": Map {},
+     "activeEffects": Array [],
+     "id": "test-enemy",
+     "name": "Test Enemy",
+     "original": Object {
+       "abilities": Array [],
+       "bookRef": Object {
+         "act": 99,
+         "book": "Test",
+       },
+       "name": "Test Enemy",
+       "stats": Object {
+         "armour": 0,
+         "brawn": 0,
+         "health": 0,
+         "magic": 0,
+         "maxHealth": 20,
+         "speed": 0,
+       },
+       "type": "enemy",
+     },
+     "stats": Object {
+       "armour": 0,
+       "brawn": 0,
+       "health": 0,
+       "magic": 0,
+       "maxHealth": 20,
+       "speed": 0,
+     },
+     "type": "enemy",
+   },
+   "enemySpeedRolls": undefined,
+   "hero": Object {
+     "activeAbilities": Map {},
+     "activeEffects": Array [],
+     "id": "test-hero",
+     "name": "Test Hero",
+     "original": Object {
+       "backpack": Array [],
+       "career": "",
+       "equipment": Object {},
+       "money": 0,
+       "name": "Test Hero",
+       "path": "",
+       "stats": Object {
+         "armour": 0,
+         "brawn": 0,
+         "health": 30,
+         "magic": 0,
+         "maxHealth": 30,
+         "speed": 0,
+       },
+       "type": "hero",
+     },
+     "stats": Object {
+       "armour": 0,
+       "brawn": 0,
+       "health": 30,
+       "magic": 0,
+       "maxHealth": 30,
+       "speed": 0,
+     },
+     "type": "hero",
+   },
+   "heroSpeedRolls": undefined,
+   "logs": Array [],
+   "phase": "combat-start",
+   "round": 0,
+   "winner": null,
+ }

 ❯ src/mechanics/abilities/passive/Barbs.test.ts:28:25
     26| 
     27|         const updates = barbs?.onPassiveAbility?.(state, 'hero');
     28|         expect(updates).toEqual({});
       |                         ^
     29|     });
     30| });

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[5/52]⎯

 FAIL  src/mechanics/abilities/passive/Bleed.test.ts > Bleed > should deal 1 damage at round end
AssertionError: expected [ Array(1) ] to deeply equal ArrayContaining{…}

- Expected
+ Received

- ArrayContaining [
-   ObjectContaining {
-     "modification": ObjectContaining {
+ Array [
+   Object {
+     "duration": undefined,
      "source": "Bleed",
+     "stats": Object {},
      "target": "enemy",
-     },
    },
  ]

 ❯ src/mechanics/abilities/passive/Bleed.test.ts:25:44
     23| 
     24|         state = ability.onDamageDealt!(state, { owner: 'hero', target:…
     25|         expect(state.enemy!.activeEffects).toEqual(
       |                                            ^
     26|             expect.arrayContaining([
     27|                 expect.objectContaining({

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[6/52]⎯

 FAIL  src/mechanics/abilities/passive/FireAura.test.ts > Fire Aura > should inflict 1 damage to enemy on round end
AssertionError: expected 10 to be 9 // Object.is equality

- Expected
+ Received

- 9
+ 10

 ❯ src/mechanics/abilities/passive/FireAura.test.ts:24:46
     22|         const updates = ability?.onPassiveAbility?.(state, 'hero');
     23| 
     24|         expect(updates?.enemy?.stats.health).toBe(9);
       |                                              ^
     25|         expect(updates?.logs?.[0].message).toContain('Fire Aura dealt …
     26|     });

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[7/52]⎯

 FAIL  src/mechanics/abilities/passive/FirstStrike.test.ts > First Strike > should deal 1d6 damage before combat
AssertionError: expected 20 to be 16 // Object.is equality

- Expected
+ Received

- 16
+ 20

 ❯ src/mechanics/abilities/passive/FirstStrike.test.ts:24:45
     22|         const updates = ability.onCombatStart!(state, 'hero');
     23| 
     24|         expect(updates.enemy!.stats.health).toBe(16); // 20 - 4
       |                                             ^
     25|         expect(updates.logs![0].message).toContain('First Strike dealt…
     26| 

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[8/52]⎯

 FAIL  src/mechanics/abilities/passive/Thorns.test.ts > Thorns > should inflict 1 damage to enemy on round end
AssertionError: expected { …(11) } to deeply equal ObjectContaining{…}

- Expected
+ Received

- ObjectContaining {
-   "enemy": ObjectContaining {
-     "stats": ObjectContaining {
-       "health": 9,
+ Object {
+   "backpack": Array [],
+   "bonusDamage": Array [],
+   "damage": undefined,
+   "enemy": Object {
+     "activeAbilities": Map {},
+     "activeEffects": Array [],
+     "id": "test-enemy",
+     "name": "Test Enemy",
+     "original": Object {
+       "abilities": Array [],
+       "bookRef": Object {
+         "act": 99,
+         "book": "Test",
+       },
+       "name": "Test Enemy",
+       "stats": Object {
+         "armour": 0,
+         "brawn": 0,
+         "health": 10,
+         "magic": 0,
+         "maxHealth": 20,
+         "speed": 0,
+       },
+       "type": "enemy",
+     },
+     "stats": Object {
+       "armour": 0,
+       "brawn": 0,
+       "health": 10,
+       "magic": 0,
+       "maxHealth": 20,
+       "speed": 0,
+     },
+     "type": "enemy",
+   },
+   "enemySpeedRolls": undefined,
+   "hero": Object {
+     "activeAbilities": Map {},
+     "activeEffects": Array [],
+     "id": "test-hero",
+     "name": "Test Hero",
+     "original": Object {
+       "backpack": Array [],
+       "career": "",
+       "equipment": Object {},
+       "money": 0,
+       "name": "Test Hero",
+       "path": "",
+       "stats": Object {
+         "armour": 0,
+         "brawn": 0,
+         "health": 30,
+         "magic": 0,
+         "maxHealth": 30,
+         "speed": 0,
+       },
+       "type": "hero",
+     },
+     "stats": Object {
+       "armour": 0,
+       "brawn": 0,
+       "health": 29,
+       "magic": 0,
+       "maxHealth": 30,
+       "speed": 0,
      },
+     "type": "hero",
    },
+   "heroSpeedRolls": undefined,
+   "logs": Array [
+     Object {
+       "message": "Thorns dealt 1 damage to Test Hero",
+       "round": 0,
+       "type": "damage-hero",
+     },
+   ],
+   "phase": "combat-start",
+   "round": 0,
+   "winner": null,
  }

 ❯ src/mechanics/abilities/passive/Thorns.test.ts:24:24
     22|         const result = ability.onPassiveAbility?.(state, 'hero');
     23| 
     24|         expect(result).toEqual(expect.objectContaining({
       |                        ^
     25|             enemy: expect.objectContaining({
     26|                 stats: expect.objectContaining({

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[9/52]⎯

 FAIL  src/mechanics/abilities/passive/Venom.test.ts > Venom > should deal 2 damage by default
AssertionError: expected 20 to be 18 // Object.is equality

- Expected
+ Received

- 18
+ 20

 ❯ src/mechanics/abilities/passive/Venom.test.ts:60:45
     58|         const updates = ability.onPassiveAbility!(state, { owner: 'her…
     59| 
     60|         expect(updates.enemy!.stats.health).toBe(18);
       |                                             ^
     61|         expect(updates.bonusDamage).toEqual(expect.arrayContaining([
     62|             expect.objectContaining({

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[10/52]⎯

 FAIL  src/mechanics/abilities/passive/Venom.test.ts > Venom > should deal 3 damage with Deadly Poisons
AssertionError: expected 20 to be 17 // Object.is equality

- Expected
+ Received

- 17
+ 20

 ❯ src/mechanics/abilities/passive/Venom.test.ts:90:45
     88|         const updates = ability.onPassiveAbility!(state, { owner: 'her…
     89| 
     90|         expect(updates.enemy!.stats.health).toBe(17);
       |                                             ^
     91|         const damageEntry = updates.bonusDamage?.find(d => d.source ==…
     92|         expect(damageEntry?.amount).toBe(3);

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[11/52]⎯

 FAIL  src/mechanics/abilities/passive/Venom.test.ts > Venom > should deal 4 damage with Poison Mastery
AssertionError: expected 20 to be 16 // Object.is equality

- Expected
+ Received

- 16
+ 20

 ❯ src/mechanics/abilities/passive/Venom.test.ts:116:45
    114|         const updates = ability.onPassiveAbility!(state, { owner: 'her…
    115| 
    116|         expect(updates.enemy!.stats.health).toBe(16);
       |                                             ^
    117|         const damageEntry = updates.bonusDamage?.find(d => d.source ==…
    118|         expect(damageEntry?.amount).toBe(4);

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[12/52]⎯

 FAIL  src/mechanics/abilities/passive/Venom.test.ts > Venom > should not deal damage if damage was only dealt to hero
AssertionError: expected [] to be undefined

- Expected: 
undefined

+ Received: 
Array []

 ❯ src/mechanics/abilities/passive/Venom.test.ts:143:37
    141|         const updates = ability.onPassiveAbility!(state, { owner: 'her…
    142|         // Should not have any damage dealt
    143|         expect(updates.bonusDamage).toBeUndefined();
       |                                     ^
    144|     });
    145| });

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[13/52]⎯

 FAIL  src/mechanics/abilities/combat/Backfire.test.ts > Backfire > should replace damage roll with specific damage
AssertionError: expected false to be true // Object.is equality

- Expected
+ Received

- true
+ false

 ❯ src/mechanics/abilities/combat/Backfire.test.ts:22:54
     20|         };
     21| 
     22|         expect(ability.canActivate?.(state, 'hero')).toBe(true);
       |                                                      ^
     23| 
     24|         const result = ability.onActivate?.(state, 'hero');

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[14/52]⎯

 FAIL  src/mechanics/abilities/combat/BlackRain.test.ts > Black Rain > should inflict random damage to enemy
AssertionError: expected { …(11) } to deeply equal ObjectContaining{…}

- Expected
+ Received

- ObjectContaining {
-   "enemy": ObjectContaining {
-     "stats": ObjectContaining {
-       "health": 14,
+ Object {
+   "backpack": Array [],
+   "bonusDamage": Array [],
+   "damage": Object {
+     "damageRolls": Array [],
+     "modifiers": Array [],
+   },
+   "enemy": Object {
+     "activeAbilities": Map {},
+     "activeEffects": Array [],
+     "id": "test-enemy",
+     "name": "Test Enemy",
+     "original": Object {
+       "abilities": Array [],
+       "bookRef": Object {
+         "act": 99,
+         "book": "Test",
+       },
+       "name": "Test Enemy",
+       "stats": Object {
+         "armour": 0,
+         "brawn": 0,
+         "health": 20,
+         "magic": 0,
+         "maxHealth": 20,
+         "speed": 0,
+       },
+       "type": "enemy",
+     },
+     "stats": Object {
+       "armour": 0,
+       "brawn": 0,
+       "health": 15,
+       "magic": 0,
+       "maxHealth": 20,
+       "speed": 0,
+     },
+     "type": "enemy",
+   },
+   "enemySpeedRolls": undefined,
+   "hero": Object {
+     "activeAbilities": Map {},
+     "activeEffects": Array [],
+     "id": "test-hero",
+     "name": "Test Hero",
+     "original": Object {
+       "backpack": Array [],
+       "career": "",
+       "equipment": Object {},
+       "money": 0,
+       "name": "Test Hero",
+       "path": "",
+       "stats": Object {
+         "armour": 0,
+         "brawn": 0,
+         "health": 30,
+         "magic": 0,
+         "maxHealth": 30,
+         "speed": 0,
+       },
+       "type": "hero",
+     },
+     "stats": Object {
+       "armour": 0,
+       "brawn": 0,
+       "health": 30,
+       "magic": 0,
+       "maxHealth": 30,
+       "speed": 0,
      },
+     "type": "hero",
    },
+   "heroSpeedRolls": undefined,
+   "logs": Array [
+     Object {
+       "message": "Black Rain dealt 5 damage to Test Enemy",
+       "round": 0,
+       "type": "damage-enemy",
+     },
+     Object {
+       "message": "Black Rain dealing 1d6 to all enemies",
+       "round": undefined,
+       "type": "info",
+     },
+   ],
    "phase": "passive-damage",
+   "round": 0,
+   "winner": "hero",
  }

 ❯ src/mechanics/abilities/combat/BlackRain.test.ts:26:24
     24|         const result = ability.onActivate?.(state, { owner: 'hero' });
     25| 
     26|         expect(result).toEqual(expect.objectContaining({
       |                        ^
     27|             phase: 'passive-damage',
     28|             enemy: expect.objectContaining({

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[15/52]⎯

 FAIL  src/mechanics/abilities/combat/Bolt.test.ts > Bolt > should charge up when activated
AssertionError: expected false to be true // Object.is equality

- Expected
+ Received

- true
+ false

 ❯ src/mechanics/abilities/combat/Bolt.test.ts:23:65
     21|         };
     22| 
     23|         expect(ability.canActivate?.(state, { owner: 'hero' })).toBe(t…
       |                                                                 ^
     24| 
     25|         const result = ability.onActivate?.(state, { owner: 'hero' });

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[16/52]⎯

 FAIL  src/mechanics/abilities/combat/Bolt.test.ts > Bolt > should release damage on subsequent onDamageRoll
ReferenceError: skipDamagePhase is not defined
 ❯ Object.onDamageRoll src/mechanics/abilities/combat/Bolt.ts:63:9
     61|         state = dealDamage(state, 'Bolt', 'enemy', dmg);
     62|         state = removeEffect(state, owner, 'Bolt');
     63|         state = skipDamagePhase(state, 'Bolt released');
       |         ^
     64|         return state;
     65|     }
 ❯ src/mechanics/abilities/combat/Bolt.test.ts:50:32

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[17/52]⎯

 FAIL  src/mechanics/abilities/combat/Brutality.test.ts > Brutality > should stop opponent damage and inflict damage back
AssertionError: expected undefined to deeply equal [ { value: +0, isRerolled: false } ]

- Expected: 
Array [
  Object {
    "isRerolled": false,
    "value": 0,
  },
]

+ Received: 
undefined

 ❯ src/mechanics/abilities/combat/Brutality.test.ts:28:37
     26| 
     27|         expect(result?.phase).toBe('round-end');
     28|         expect(result?.damageRolls).toEqual([{ value: 0, isRerolled: f…
       |                                     ^
     29|         expect(result?.damageDealt).toHaveLength(1);
     30|         expect(result?.damageDealt![0].target).toBe('enemy');

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[18/52]⎯

 FAIL  src/mechanics/abilities/combat/Corruption.test.ts > Corruption > should apply corruption buff on activate if damage dealt
AssertionError: expected undefined to be true // Object.is equality

- Expected: 
true

+ Received: 
undefined

 ❯ src/mechanics/abilities/combat/Corruption.test.ts:28:65
     26|         };
     27| 
     28|         expect(ability.canActivate?.(state, { owner: 'hero' })).toBe(t…
       |                                                                 ^
     29| 
     30|         const result = ability.onActivate?.(state, { owner: 'hero' });

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[19/52]⎯

 FAIL  src/mechanics/abilities/combat/Corruption.test.ts > Corruption > should not activate if no damage dealt
AssertionError: expected undefined to be false // Object.is equality

- Expected: 
false

+ Received: 
undefined

 ❯ src/mechanics/abilities/combat/Corruption.test.ts:43:65
     41|         };
     42| 
     43|         expect(ability.canActivate?.(state, { owner: 'hero' })).toBe(f…
       |                                                                 ^
     44|         const result = ability.onActivate?.(state, { owner: 'hero' });
     45|         // Assumption: returns null or state if failed?

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[20/52]⎯

 FAIL  src/mechanics/abilities/combat/Cripple.test.ts > Cripple > should apply speed reduction on activate when damage is dealt
AssertionError: Target cannot be null or undefined.
 ❯ src/mechanics/abilities/combat/Cripple.test.ts:26:39
     24|         const result = ability.onActivate?.(state, 'hero');
     25| 
     26|         expect(result?.modifications).toHaveLength(1);
       |                                       ^
     27|         expect(result?.modifications![0].modification.stats.speed).toB…
     28|         expect(result?.modifications![0].duration).toBe(3);

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[21/52]⎯

 FAIL  src/mechanics/abilities/combat/Cripple.test.ts > Cripple > should not activate if no damage dealt to enemy
AssertionError: expected { …(12) } to deeply equal {}

- Expected
+ Received

- Object {}
+ Object {
+   "backpack": Array [],
+   "bonusDamage": Array [],
+   "damage": undefined,
+   "damageDealt": Array [],
+   "enemy": Object {
+     "activeAbilities": Map {},
+     "activeEffects": Array [],
+     "id": "test-enemy",
+     "name": "Test Enemy",
+     "original": Object {
+       "abilities": Array [],
+       "bookRef": Object {
+         "act": 99,
+         "book": "Test",
+       },
+       "name": "Test Enemy",
+       "stats": Object {
+         "armour": 0,
+         "brawn": 0,
+         "health": 20,
+         "magic": 0,
+         "maxHealth": 20,
+         "speed": 0,
+       },
+       "type": "enemy",
+     },
+     "stats": Object {
+       "armour": 0,
+       "brawn": 0,
+       "health": 20,
+       "magic": 0,
+       "maxHealth": 20,
+       "speed": 0,
+     },
+     "type": "enemy",
+   },
+   "enemySpeedRolls": undefined,
+   "hero": Object {
+     "activeAbilities": Map {},
+     "activeEffects": Array [],
+     "id": "test-hero",
+     "name": "Test Hero",
+     "original": Object {
+       "backpack": Array [],
+       "career": "",
+       "equipment": Object {},
+       "money": 0,
+       "name": "Test Hero",
+       "path": "",
+       "stats": Object {
+         "armour": 0,
+         "brawn": 0,
+         "health": 30,
+         "magic": 0,
+         "maxHealth": 30,
+         "speed": 0,
+       },
+       "type": "hero",
+     },
+     "stats": Object {
+       "armour": 0,
+       "brawn": 0,
+       "health": 30,
+       "magic": 0,
+       "maxHealth": 30,
+       "speed": 0,
+     },
+     "type": "hero",
+   },
+   "heroSpeedRolls": undefined,
+   "logs": Array [],
+   "phase": "combat-start",
+   "round": 0,
+   "winner": null,
+ }

 ❯ src/mechanics/abilities/combat/Cripple.test.ts:40:24
     38|         expect(ability.canActivate?.(state, 'hero')).toBe(false);
     39|         const result = ability.onActivate?.(state, 'hero');
     40|         expect(result).toEqual({});
       |                        ^
     41|     });
     42| });

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[22/52]⎯

 FAIL  src/mechanics/abilities/combat/DarkPact.test.ts > Dark Pact > should sacrifice health for damage
AssertionError: expected [ { …(4) } ] to have a length of 2 but got 1

- Expected
+ Received

- 2
+ 1

 ❯ src/mechanics/abilities/combat/DarkPact.test.ts:24:44
     22|         const result = ability.onActivate?.(state, { owner: 'hero' });
     23| 
     24|         expect(result?.hero.activeEffects).toHaveLength(2);
       |                                            ^
     25|         // Order undefined.
     26|         const healthMod = result?.hero.activeEffects.find(e => e.stats…

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[23/52]⎯

 FAIL  src/mechanics/abilities/combat/DeepWound.test.ts > Deep Wound > should add 1 damage die
TypeError: Cannot read properties of undefined (reading 'stats')
 ❯ Object.onActivate src/mechanics/abilities/combat/DeepWound.ts:10:54
      8|     canActivate: (state, owner) => state.phase === 'damage-roll' && st…
      9|     onActivate: (state, owner) => {
     10|         const currentDamageDiceCount = state[owner]!.stats.damageDice …
       |                                                      ^
     11|         return createStatModification(
     12|             {
 ❯ src/mechanics/abilities/combat/DeepWound.test.ts:17:33

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[24/52]⎯

 FAIL  src/mechanics/abilities/combat/Deflect.test.ts > Deflect > should stop opponent damage and inflict damage back
AssertionError: expected undefined to deeply equal [ { value: +0, isRerolled: false } ]

- Expected: 
Array [
  Object {
    "isRerolled": false,
    "value": 0,
  },
]

+ Received: 
undefined

 ❯ src/mechanics/abilities/combat/Deflect.test.ts:28:37
     26| 
     27|         expect(result?.phase).toBe('round-end');
     28|         expect(result?.damageRolls).toEqual([{ value: 0, isRerolled: f…
       |                                     ^
     29|         expect(result?.damageDealt).toHaveLength(1);
     30|         expect(result?.damageDealt![0].target).toBe('enemy');

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[25/52]⎯

 FAIL  src/mechanics/abilities/combat/Disrupt.test.ts > Disrupt > should apply magic reduction on activate if damage dealt
TypeError: Cannot read properties of undefined (reading 'some')
 ❯ Object.canActivate src/mechanics/abilities/combat/Disrupt.ts:7:30
      5| 
      6| function canActivate(state: CombatState, _owner: CharacterType): boole…
      7|     return state.damageDealt.some(d => d.target === 'enemy' && d.amoun…
       |                              ^
      8| }
      9| 
 ❯ src/mechanics/abilities/combat/Disrupt.test.ts:28:24

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[26/52]⎯

 FAIL  src/mechanics/abilities/combat/Disrupt.test.ts > Disrupt > should not activate if no damage dealt
TypeError: Cannot read properties of undefined (reading 'some')
 ❯ Object.canActivate src/mechanics/abilities/combat/Disrupt.ts:7:30
      5| 
      6| function canActivate(state: CombatState, _owner: CharacterType): boole…
      7|     return state.damageDealt.some(d => d.target === 'enemy' && d.amoun…
       |                              ^
      8| }
      9| 
 ❯ src/mechanics/abilities/combat/Disrupt.test.ts:44:24

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[27/52]⎯

 FAIL  src/mechanics/abilities/combat/Dodge.test.ts > Dodge > should avoid damage
TypeError: Cannot read properties of undefined (reading 'some')
 ❯ canActivate src/mechanics/abilities/combat/Dodge.ts:12:48
     10|     blockMessage: 'Evaded attack!',
     11|     canActivate: (state: CombatState, _owner: CharacterType) => {
     12|         const isDisabled = state.activeEffects.some(e => e.modificatio…
       |                                                ^
     13|         return !isDisabled && isEnemyDamageRollPhase(state);
     14|     }
 ❯ Object.onActivate src/mechanics/abilities/abilityFactories.ts:105:18
 ❯ src/mechanics/abilities/combat/Dodge.test.ts:11:33

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[28/52]⎯

 FAIL  src/mechanics/abilities/combat/Ensnare.test.ts > Ensnare > should apply Ensnare effect
AssertionError: Target cannot be null or undefined.
 ❯ src/mechanics/abilities/combat/Ensnare.test.ts:29:39
     27|         const result = ability.onActivate?.(state, 'hero');
     28| 
     29|         expect(result?.modifications).toHaveLength(1);
       |                                       ^
     30|         expect(result?.modifications![0].modification.source).toBe('En…
     31|     });

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[29/52]⎯

 FAIL  src/mechanics/abilities/combat/FatalBlow.test.ts > Fatal Blow > should apply modifier on activate
AssertionError: Target cannot be null or undefined.
 ❯ src/mechanics/abilities/combat/FatalBlow.test.ts:19:39
     17|         const result = ability.onActivate?.(state, 'hero');
     18| 
     19|         expect(result?.modifications).toHaveLength(1);
       |                                       ^
     20|         expect(result?.modifications![0].modification.source).toBe('Fa…
     21|     });

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[30/52]⎯

 FAIL  src/mechanics/abilities/combat/FeralFury.test.ts > Feral Fury > should add extra damage die
TypeError: Cannot read properties of undefined (reading 'activeEffects')
 ❯ Module.appendEffect src/types/CombatState.ts:210:34
    208|             ...state[target],
    209|             activeEffects: [
    210|                 ...state[target].activeEffects,
       |                                  ^
    211|                 effect,
    212|             ],
 ❯ Object.onActivate src/mechanics/abilities/combat/FeralFury.ts:9:26
 ❯ src/mechanics/abilities/combat/FeralFury.test.ts:17:32

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[31/52]⎯

 FAIL  src/mechanics/abilities/combat/Hamstring.test.ts > Hamstring > should apply Hamstring effect
TypeError: Cannot read properties of undefined (reading 'activeEffects')
 ❯ Module.appendEffect src/types/CombatState.ts:210:34
    208|             ...state[target],
    209|             activeEffects: [
    210|                 ...state[target].activeEffects,
       |                                  ^
    211|                 effect,
    212|             ],
 ❯ Object.onActivate src/mechanics/abilities/combat/Hamstring.ts:18:16
 ❯ src/mechanics/abilities/combat/Hamstring.test.ts:21:32

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[32/52]⎯

 FAIL  src/mechanics/abilities/combat/HeadButt.test.ts > Head Butt > should stop opponent damage
AssertionError: expected 'passive-damage' to be 'round-end' // Object.is equality

Expected: "round-end"
Received: "passive-damage"

 ❯ src/mechanics/abilities/combat/HeadButt.test.ts:26:31
     24|         const result = ability.onActivate?.(state, 'hero');
     25| 
     26|         expect(result?.phase).toBe('round-end');
       |                               ^
     27|         expect(result?.damageRolls).toEqual([{ value: 0, isRerolled: f…
     28|     });

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[33/52]⎯

 FAIL  src/mechanics/abilities/combat/Impale.test.ts > Impale > should apply damage buff and speed debuff
TypeError: Cannot read properties of undefined (reading 'activeEffects')
 ❯ Module.appendEffect src/types/CombatState.ts:210:34
    208|             ...state[target],
    209|             activeEffects: [
    210|                 ...state[target].activeEffects,
       |                                  ^
    211|                 effect,
    212|             ],
 ❯ Object.onActivate src/mechanics/abilities/combat/Impale.ts:10:24
 ❯ src/mechanics/abilities/combat/Impale.test.ts:17:32

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[34/52]⎯

 FAIL  src/mechanics/abilities/combat/NaturesRevenge.test.ts > Nature's Revenge > should inflict damage and slow opponent
AssertionError: expected false to be true // Object.is equality

- Expected
+ Received

- true
+ false

 ❯ src/mechanics/abilities/combat/NaturesRevenge.test.ts:23:54
     21|         };
     22| 
     23|         expect(ability.canActivate?.(state, 'hero')).toBe(true);
       |                                                      ^
     24| 
     25|         const result = ability.onActivate?.(state, 'hero');

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[35/52]⎯

 FAIL  src/mechanics/abilities/combat/Overload.test.ts > Overload > should add extra damage die if winner is hero and phase is damage-roll
AssertionError: Target cannot be null or undefined.
 ❯ src/mechanics/abilities/combat/Overload.test.ts:27:39
     25|         const result = ability.onActivate?.(state, 'hero');
     26| 
     27|         expect(result?.modifications).toHaveLength(1);
       |                                       ^
     28|         expect(result?.modifications![0].modification.stats.damageDice…
     29|     });

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[36/52]⎯

 FAIL  src/mechanics/abilities/combat/Overload.test.ts > Overload > should not activate if not damage-roll phase
AssertionError: expected { …(11) } to deeply equal {}

- Expected
+ Received

- Object {}
+ Object {
+   "backpack": Array [],
+   "bonusDamage": Array [],
+   "damage": undefined,
+   "enemy": Object {
+     "activeAbilities": Map {},
+     "activeEffects": Array [],
+     "id": "test-enemy",
+     "name": "Test Enemy",
+     "original": Object {
+       "abilities": Array [],
+       "bookRef": Object {
+         "act": 99,
+         "book": "Test",
+       },
+       "name": "Test Enemy",
+       "stats": Object {
+         "armour": 0,
+         "brawn": 0,
+         "health": 20,
+         "magic": 0,
+         "maxHealth": 20,
+         "speed": 0,
+       },
+       "type": "enemy",
+     },
+     "stats": Object {
+       "armour": 0,
+       "brawn": 0,
+       "health": 20,
+       "magic": 0,
+       "maxHealth": 20,
+       "speed": 0,
+     },
+     "type": "enemy",
+   },
+   "enemySpeedRolls": undefined,
+   "hero": Object {
+     "activeAbilities": Map {},
+     "activeEffects": Array [],
+     "id": "test-hero",
+     "name": "Test Hero",
+     "original": Object {
+       "backpack": Array [],
+       "career": "",
+       "equipment": Object {},
+       "money": 0,
+       "name": "Test Hero",
+       "path": "",
+       "stats": Object {
+         "armour": 0,
+         "brawn": 0,
+         "health": 30,
+         "magic": 0,
+         "maxHealth": 30,
+         "speed": 0,
+       },
+       "type": "hero",
+     },
+     "stats": Object {
+       "armour": 0,
+       "brawn": 0,
+       "health": 30,
+       "magic": 0,
+       "maxHealth": 30,
+       "speed": 0,
+     },
+     "type": "hero",
+   },
+   "heroSpeedRolls": undefined,
+   "logs": Array [],
+   "phase": "speed-roll",
+   "round": 0,
+   "winner": "hero",
+ }

 ❯ src/mechanics/abilities/combat/Overload.test.ts:40:24
     38|         expect(ability.canActivate?.(state, 'hero')).toBe(false);
     39|         const result = ability.onActivate?.(state, 'hero');
     40|         expect(result).toEqual({});
       |                        ^
     41|     });
     42| 

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[37/52]⎯

 FAIL  src/mechanics/abilities/combat/Overload.test.ts > Overload > should not activate if winner is not hero
AssertionError: expected { …(11) } to deeply equal {}

- Expected
+ Received

- Object {}
+ Object {
+   "backpack": Array [],
+   "bonusDamage": Array [],
+   "damage": undefined,
+   "enemy": Object {
+     "activeAbilities": Map {},
+     "activeEffects": Array [],
+     "id": "test-enemy",
+     "name": "Test Enemy",
+     "original": Object {
+       "abilities": Array [],
+       "bookRef": Object {
+         "act": 99,
+         "book": "Test",
+       },
+       "name": "Test Enemy",
+       "stats": Object {
+         "armour": 0,
+         "brawn": 0,
+         "health": 20,
+         "magic": 0,
+         "maxHealth": 20,
+         "speed": 0,
+       },
+       "type": "enemy",
+     },
+     "stats": Object {
+       "armour": 0,
+       "brawn": 0,
+       "health": 20,
+       "magic": 0,
+       "maxHealth": 20,
+       "speed": 0,
+     },
+     "type": "enemy",
+   },
+   "enemySpeedRolls": undefined,
+   "hero": Object {
+     "activeAbilities": Map {},
+     "activeEffects": Array [],
+     "id": "test-hero",
+     "name": "Test Hero",
+     "original": Object {
+       "backpack": Array [],
+       "career": "",
+       "equipment": Object {},
+       "money": 0,
+       "name": "Test Hero",
+       "path": "",
+       "stats": Object {
+         "armour": 0,
+         "brawn": 0,
+         "health": 30,
+         "magic": 0,
+         "maxHealth": 30,
+         "speed": 0,
+       },
+       "type": "hero",
+     },
+     "stats": Object {
+       "armour": 0,
+       "brawn": 0,
+       "health": 30,
+       "magic": 0,
+       "maxHealth": 30,
+       "speed": 0,
+     },
+     "type": "hero",
+   },
+   "heroSpeedRolls": undefined,
+   "logs": Array [],
+   "phase": "damage-roll",
+   "round": 0,
+   "winner": "enemy",
+ }

 ❯ src/mechanics/abilities/combat/Overload.test.ts:52:24
     50|         expect(ability.canActivate?.(state, 'hero')).toBe(false);
     51|         const result = ability.onActivate?.(state, 'hero');
     52|         expect(result).toEqual({});
       |                        ^
     53|     });
     54| });

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[38/52]⎯

 FAIL  src/mechanics/abilities/combat/Overpower.test.ts > Overpower > should block attack and deal counter damage
AssertionError: expected { …(12) } to deeply equal ObjectContaining{…}

- Expected
+ Received

- ObjectContaining {
-   "damageRolls": Array [
  Object {
-       "isRerolled": false,
-       "value": 0,
+   "backpack": Array [],
+   "bonusDamage": Array [],
+   "damage": Object {
+     "damageRolls": Array [],
+     "modifiers": Array [],
+   },
+   "damageDealt": Array [],
+   "enemy": Object {
+     "activeAbilities": Map {},
+     "activeEffects": Array [],
+     "id": "test-enemy",
+     "name": "Test Enemy",
+     "original": Object {
+       "abilities": Array [],
+       "bookRef": Object {
+         "act": 99,
+         "book": "Test",
+       },
+       "name": "Test Enemy",
+       "stats": Object {
+         "armour": 0,
+         "brawn": 0,
+         "health": 20,
+         "magic": 0,
+         "maxHealth": 20,
+         "speed": 0,
        },
-   ],
-   "enemy": ObjectContaining {
-     "stats": ObjectContaining {
+       "type": "enemy",
+     },
+     "stats": Object {
+       "armour": 0,
+       "brawn": 0,
        "health": 11,
+       "magic": 0,
+       "maxHealth": 20,
+       "speed": 0,
+     },
+     "type": "enemy",
+   },
+   "enemySpeedRolls": undefined,
+   "hero": Object {
+     "activeAbilities": Map {},
+     "activeEffects": Array [],
+     "id": "test-hero",
+     "name": "Test Hero",
+     "original": Object {
+       "backpack": Array [],
+       "career": "",
+       "equipment": Object {},
+       "money": 0,
+       "name": "Test Hero",
+       "path": "",
+       "stats": Object {
+         "armour": 0,
+         "brawn": 0,
+         "health": 30,
+         "magic": 0,
+         "maxHealth": 30,
+         "speed": 0,
+       },
+       "type": "hero",
+     },
+     "stats": Object {
+       "armour": 0,
+       "brawn": 0,
+       "health": 30,
+       "magic": 0,
+       "maxHealth": 30,
+       "speed": 0,
      },
+     "type": "hero",
    },
+   "heroSpeedRolls": undefined,
+   "logs": Array [
+     Object {
+       "message": "Overpower dealt 9 damage to Test Enemy",
+       "round": 1,
+       "type": "damage-enemy",
+     },
+     Object {
+       "message": "Overpower blocked attack",
+       "round": undefined,
+       "type": "info",
+     },
+   ],
    "phase": "passive-damage",
+   "round": 1,
+   "winner": "enemy",
  }

 ❯ src/mechanics/abilities/combat/Overpower.test.ts:41:24
     39|         assert(result !== null);
     40| 
     41|         expect(result).toEqual(expect.objectContaining({
       |                        ^
     42|             phase: 'passive-damage',
     43|             damageRolls: [{ value: 0, isRerolled: false }],

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[39/52]⎯

 FAIL  src/mechanics/abilities/combat/Parry.test.ts > Parry > should be activatable only in damage-roll phase when enemy won
AssertionError: expected undefined to deeply equal [ { value: +0, isRerolled: false } ]

- Expected: 
Array [
  Object {
    "isRerolled": false,
    "value": 0,
  },
]

+ Received: 
undefined

 ❯ src/mechanics/abilities/combat/Parry.test.ts:35:38
     33| 
     34|         expect(updates?.phase).toBe('round-end');
     35|         expect(updates?.damageRolls).toEqual([{ value: 0, isRerolled: …
       |                                      ^
     36|         expect(updates?.logs?.[0].message).toContain('blocked');
     37|     });

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[40/52]⎯

 FAIL  src/mechanics/abilities/combat/Rust.test.ts > Rust > should reduce opponent armour if damage dealt
AssertionError: Target cannot be null or undefined.
 ❯ src/mechanics/abilities/combat/Rust.test.ts:26:39
     24|         const result = ability.onActivate?.(state, 'hero');
     25| 
     26|         expect(result?.modifications).toHaveLength(1);
       |                                       ^
     27|         expect(result?.modifications![0].modification.stats.armour).to…
     28|     });

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[41/52]⎯

 FAIL  src/mechanics/abilities/combat/Rust.test.ts > Rust > should not activate if no damage dealt
AssertionError: expected { …(12) } to deeply equal {}

- Expected
+ Received

- Object {}
+ Object {
+   "backpack": Array [],
+   "bonusDamage": Array [],
+   "damage": undefined,
+   "damageDealt": Array [],
+   "enemy": Object {
+     "activeAbilities": Map {},
+     "activeEffects": Array [],
+     "id": "test-enemy",
+     "name": "Test Enemy",
+     "original": Object {
+       "abilities": Array [],
+       "bookRef": Object {
+         "act": 99,
+         "book": "Test",
+       },
+       "name": "Test Enemy",
+       "stats": Object {
+         "armour": 0,
+         "brawn": 0,
+         "health": 20,
+         "magic": 0,
+         "maxHealth": 20,
+         "speed": 0,
+       },
+       "type": "enemy",
+     },
+     "stats": Object {
+       "armour": 0,
+       "brawn": 0,
+       "health": 20,
+       "magic": 0,
+       "maxHealth": 20,
+       "speed": 0,
+     },
+     "type": "enemy",
+   },
+   "enemySpeedRolls": undefined,
+   "hero": Object {
+     "activeAbilities": Map {},
+     "activeEffects": Array [],
+     "id": "test-hero",
+     "name": "Test Hero",
+     "original": Object {
+       "backpack": Array [],
+       "career": "",
+       "equipment": Object {},
+       "money": 0,
+       "name": "Test Hero",
+       "path": "",
+       "stats": Object {
+         "armour": 0,
+         "brawn": 0,
+         "health": 30,
+         "magic": 0,
+         "maxHealth": 30,
+         "speed": 0,
+       },
+       "type": "hero",
+     },
+     "stats": Object {
+       "armour": 0,
+       "brawn": 0,
+       "health": 30,
+       "magic": 0,
+       "maxHealth": 30,
+       "speed": 0,
+     },
+     "type": "hero",
+   },
+   "heroSpeedRolls": undefined,
+   "logs": Array [],
+   "phase": "combat-start",
+   "round": 0,
+   "winner": null,
+ }

 ❯ src/mechanics/abilities/combat/Rust.test.ts:38:24
     36|         expect(ability.canActivate?.(state, 'hero')).toBe(false);
     37|         const result = ability.onActivate?.(state, 'hero');
     38|         expect(result).toEqual({});
       |                        ^
     39|     });
     40| });

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[42/52]⎯

 FAIL  src/mechanics/abilities/combat/ShieldWall.test.ts > Shield Wall > should double armour and inflict damage
TypeError: Cannot read properties of undefined (reading 'stats')
 ❯ Object.onActivate src/mechanics/abilities/combat/ShieldWall.ts:13:37
     11|     onActivate: (state, { owner }) => {
     12|         // TODO: Validation of shield left hand?
     13|         const armour = state[owner].stats.armour || 0;
       |                                     ^
     14|         // Double means add equal amount.
     15| 
 ❯ src/mechanics/abilities/combat/ShieldWall.test.ts:21:32

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[43/52]⎯

 FAIL  src/mechanics/abilities/combat/Sidestep.test.ts > Sidestep > should boost armour by 200 on activation
TypeError: Cannot read properties of undefined (reading '0')
 ❯ src/mechanics/abilities/combat/Sidestep.test.ts:19:25
     17|         const updates = ability.onActivate?.(state, 'hero');
     18| 
     19|         expect(updates!.modifications![0].modification.stats.armour).t…
       |                         ^
     20|         expect(updates!.modifications![0].duration).toBe(1);
     21|     });

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[44/52]⎯

 FAIL  src/mechanics/abilities/combat/Sideswipe.test.ts > Sideswipe > should inflict damage back
AssertionError: expected [] to have a length of 1 but got +0

- Expected
+ Received

- 1
+ 0

 ❯ src/mechanics/abilities/combat/Sideswipe.test.ts:20:37
     18| 
     19|         const result = ability.onDamageDealt?.(state, { owner: 'hero',…
     20|         expect(result?.bonusDamage).toHaveLength(1);
       |                                     ^
     21|         expect(result?.bonusDamage![0].amount).toEqual(3);
     22|     });

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[45/52]⎯

 FAIL  src/mechanics/abilities/combat/SporeCloud.test.ts > Spore Cloud > should inflict 2 dice damage back
AssertionError: expected [] to have a length of 1 but got +0

- Expected
+ Received

- 1
+ 0

 ❯ src/mechanics/abilities/combat/SporeCloud.test.ts:21:37
     19|         const result = ability.onDamageDealt?.(state, { owner: 'hero',…
     20| 
     21|         expect(result?.bonusDamage).toHaveLength(1);
       |                                     ^
     22|         expect(result?.bonusDamage![0].amount).toBeGreaterThanOrEqual(…
     23|     });

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[46/52]⎯

 FAIL  src/mechanics/abilities/combat/ThornFist.test.ts > Thorn Fist > should inflict 2 dice damage back
AssertionError: expected [] to have a length of 1 but got +0

- Expected
+ Received

- 1
+ 0

 ❯ src/mechanics/abilities/combat/ThornFist.test.ts:21:37
     19|         const result = ability.onDamageDealt?.(state, { owner: 'hero',…
     20| 
     21|         expect(result?.bonusDamage).toHaveLength(1);
       |                                     ^
     22|         expect(result?.bonusDamage![0].amount).toBeGreaterThanOrEqual(…
     23|     });

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[47/52]⎯

 FAIL  src/mechanics/abilities/combat/Windwalker.test.ts > Windwalker > should use speed dice for damage
AssertionError: Target cannot be null or undefined.
 ❯ src/mechanics/abilities/combat/Windwalker.test.ts:26:37
     24| 
     25|         expect(result?.phase).toBe('round-end');
     26|         expect(result?.damageDealt).toHaveLength(1);
       |                                     ^
     27|         // Should have rolled 5 dice. Sum >= 5.
     28|         expect(result?.damageDealt![0].amount).toBeGreaterThanOrEqual(…

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[48/52]⎯

 Test Files  41 failed | 44 passed (85)
      Tests  45 failed | 73 passed (118)
   Start at  13:51:27
   Duration  12.16s (transform 1.47s, setup 10.83s, collect 4.30s, tests 437ms, environment 40.30s, prepare 6.84s)

================================================================================
INFO: Found 1 test target...
Target //:test up-to-date:
  /private/var/tmp/_bazel_maus/00d397edd867a4184343b978ca9644d8/execroot/_main/bazel-out/darwin_arm64-fastbuild/bin/test_/test
INFO: Elapsed time: 19.378s, Critical Path: 14.19s
INFO: 4 processes: 8 action cache hit, 2 darwin-sandbox, 2 local.
INFO: Build completed, 1 test FAILED, 4 total actions
//:test                                                                  FAILED in 12.7s
  /private/var/tmp/_bazel_maus/00d397edd867a4184343b978ca9644d8/execroot/_main/bazel-out/darwin_arm64-fastbuild/testlogs/test/test.log

Executed 1 out of 1 test: 1 fails locally.
